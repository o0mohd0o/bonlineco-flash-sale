<?php
/** @var $block \Bonlineco\FlashSale\Block\Badge */
$product = $block->getProduct();
if (!$product) {
    return;
}
$pid = (int)$product->getId();
$iconUrl = $block->getIconUrl();
$isActive = $block->isActive();
$endTs = $block->getCountdownEnd();
$activeChildren = $block->getActiveChildrenIds();
$endsMap = $block->getEndsMap();

if (!$isActive) {
    return;
}
?>
<span class="flash-sale-icon bonlineco-flashsale-badge" data-product-id="<?= $pid ?>"
      data-active-children='<?= htmlspecialchars(json_encode($activeChildren), ENT_QUOTES, 'UTF-8') ?>'
      data-ends='<?= htmlspecialchars(json_encode($endsMap), ENT_QUOTES, 'UTF-8') ?>'
      style="display:block;margin:0;line-height:0;">
    <img src="<?= $iconUrl ?>" alt="Flash Sale" title="Flash Sale"
         style="width:100px;height:40px;display:inline-block;object-fit:contain;vertical-align:middle;" />
    <?php if ($endTs): ?>
        <div class="flash-sale-countdown" id="flash-countdown-<?= $pid ?>"
             style="font-size:16px;color:#ff4444;font-weight:bold; margin-top:10px; margin-bottom:10px;"
             data-product-id="<?= $pid ?>" data-end-time="<?= (int)$endTs ?>">Loading...</div>
    <?php endif; ?>
</span>
<?php if ($endTs): ?>
<script type="text/javascript">
require(['jquery'], function($) {
    var pid = <?= (int)$pid ?>;
    var countEl = $("#flash-countdown-" + pid);
    function updateCountdown() {
        if (!countEl.length) { return; }
        var endAttr = parseInt(countEl.attr("data-end-time"), 10) || 0;
        if (!endAttr) { return; }
        var endTime = endAttr * 1000;
        var now = new Date().getTime();
        var timeLeft = endTime - now;
        if (timeLeft > 0) {
            var days = Math.floor(timeLeft / (1000 * 60 * 60 * 24));
            var hours = Math.floor((timeLeft % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            var minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
            var seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);
            var display = "";
            if (days > 0) display += days + "d ";
            if (hours > 0) display += hours + "h ";
            if (minutes > 0) display += minutes + "m ";
            display += seconds + "s";
            countEl.text("‚è∞ " + display);
        } else {
            countEl.text("Flash Sale Ended");
            clearInterval(window["flashSaleInterval" + pid]);
        }
    }
    updateCountdown();
    if (!window["flashSaleInterval" + pid]) {
        window["flashSaleInterval" + pid] = setInterval(function(){ updateCountdown(); }, 1000);
    }
});
</script>
<?php endif; ?>
